<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Anchor Context Console</title>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #1e293b;
            --text: #e2e8f0;
            --accent: #38bdf8;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: system-ui;
            margin: 0;
            padding: 20px;
            height: 100vh;
            display: flex;
            gap: 20px;
            box-sizing: border-box;
        }

        .sidebar {
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--panel);
            border-radius: 12px;
            border: 1px solid #334155;
            padding: 20px;
        }

        input,
        button {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #334155;
            background: #000;
            color: #fff;
            box-sizing: border-box;
        }

        button {
            background: var(--accent);
            color: #000;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }

        button:hover {
            opacity: 0.9;
        }

        textarea {
            flex: 1;
            background: #000;
            color: #a5f3fc;
            border: none;
            padding: 15px;
            font-family: monospace;
            resize: none;
            outline: none;
            border-radius: 8px;
        }

        .slider-group {
            background: var(--panel);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #334155;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: #94a3b8;
        }

        .bucket-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
            min-height: 40px;
            padding: 5px;
            border: 1px solid #334155;
            border-radius: 8px;
            background: #000;
        }

        .bucket-chip {
            padding: 6px 12px;
            border-radius: 16px;
            background: #334155;
            color: #94a3b8;
            font-size: 0.8rem;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .bucket-chip.active {
            background: var(--accent);
            color: #000;
            font-weight: bold;
        }

        .bucket-chip:hover {
            border-color: var(--accent);
        }

        .bucket-add {
            background: #10b981;
            color: white;
            padding: 6px 10px;
            border-radius: 16px;
            font-size: 0.8rem;
            cursor: pointer;
            border: none;
        }

        .bucket-dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-btn {
            background: #334155;
            color: #94a3b8;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.8rem;
            cursor: pointer;
            border: 1px solid #475569;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: #1e293b;
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
            z-index: 1;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #334155;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background-color: #334155;
        }

        .dropdown-item.active {
            background-color: var(--accent);
            color: #000;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div>
            <label>ðŸ“¦ Search Scope (Buckets)</label>
            <p style="font-size: 0.75rem; color: #64748b; margin: 0 0 8px 0;">Toggle buckets to expand or narrow your search</p>
            <div id="bucket-list" class="bucket-container">
                <!-- Active buckets will be shown as chips, overflow goes to dropdown -->
                <div id="active-buckets-container">
                    <!-- Active buckets as chips will be loaded here -->
                </div>
                <div class="bucket-dropdown">
                    <div class="dropdown-btn" onclick="toggleDropdown()">
                        <span>â–¼</span> More
                    </div>
                    <div id="dropdown-content" class="dropdown-content">
                        <!-- All available buckets will be listed here -->
                    </div>
                </div>
            </div>
        </div>
        <div>
            <label>ðŸ”Ž Search Memory</label>
            <input type="text" id="query" placeholder="Type keyword..." onkeyup="if(event.key==='Enter') search()">
        </div>
        <div class="slider-group">
            <label>Volume: <span id="vol-val">5000</span> chars (â‰ˆ<span id="tok-val">1250</span> tokens)</label>
            <input type="range" id="vol" min="1000" max="4000000" step="1000" value="5000"
                oninput="document.getElementById('vol-val').innerText=this.value; document.getElementById('tok-val').innerText=Math.floor(this.value/4)">
            <div style="margin-top: 10px; display: flex; gap: 10px;">
                <input type="number" id="vol-input" value="5000" min="1000" max="4000000"
                    oninput="updateSliderFromInput()"
                    style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #334155; background: #000; color: #fff;">
                <button onclick="setPreset(5000)" style="padding: 8px 12px; font-size: 0.8rem;">5K</button>
                <button onclick="setPreset(10000)" style="padding: 8px 12px; font-size: 0.8rem;">10K</button>
                <button onclick="setPreset(25000)" style="padding: 8px 12px; font-size: 0.8rem;">25K</button>
                <button onclick="setPreset(50000)" style="padding: 8px 12px; font-size: 0.8rem;">50K</button>
            </div>
        </div>
        <button onclick="search()">Fetch Context</button>
        <button onclick="research()" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: #000; margin-top: 10px; border: 1px solid #b45309; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">ðŸ”¬ Deep Research</button>
        <button onclick="copy()" style="background: #334155; color: #fff; border: 1px solid #475569; margin-top: 10px;">ðŸ“‹ Copy to
            Clipboard</button>
        <button onclick="downloadBackup()" style="background: #10b981; color: white; margin-top: 10px; border: 1px solid #059669">
            ðŸ’¾ Eject Memory (Backup)
        </button>
        <button onclick="triggerDream()" style="background: #8b5cf6; color: white; margin-top: 10px; border: 1px solid #7c3aed">
            ðŸŒ™ Trigger Dreamer (Self-Organize)
        </button>

        <div style="margin-top: 20px; border-top: 1px solid #334155; padding-top: 20px;">
            <label>ðŸ“¥ Ingest New Memory</label>
            <textarea id="ingest-text" style="height: 100px; width: 100%; margin-bottom: 10px;" placeholder="Paste chat session here..."></textarea>
            <input type="text" id="ingest-source" placeholder="Source (e.g. Gemini Chat)" style="margin-bottom: 10px;">
            <button onclick="ingest()" style="background: #6366f1; color: white;">Ingest Memory</button>
        </div>
    </div>
    <div class="main">
        <textarea id="output" readonly placeholder="Context results will appear here..."></textarea>
    </div>
    <script>
        let activeBuckets = ['core'];
        let allBuckets = [];
        let dropdownVisible = false;

        // Function to toggle the dropdown visibility
        function toggleDropdown() {
            const dropdown = document.getElementById('dropdown-content');
            dropdown.classList.toggle('show');
            dropdownVisible = dropdown.classList.contains('show');
        }

        // Close dropdown when clicking elsewhere
        window.onclick = function(event) {
            if (!event.target.closest('.bucket-dropdown')) {
                const dropdown = document.getElementById('dropdown-content');
                if (dropdown.classList.contains('show')) {
                    dropdown.classList.remove('show');
                    dropdownVisible = false;
                }
            }
        }

        async function loadBuckets() {
            try {
                const res = await fetch('http://localhost:3000/v1/buckets');
                const serverBuckets = await res.json();

                // Store all buckets for the dropdown
                allBuckets = serverBuckets;

                // Merge server buckets with active buckets to ensure newly added ones show up
                const allKnownBuckets = [...new Set([...serverBuckets, ...activeBuckets.filter(b => b !== 'all')])].sort();

                // Update active buckets container
                const activeContainer = document.getElementById('active-buckets-container');
                activeContainer.innerHTML = '';

                // Add "All" option if it's active
                if (activeBuckets.includes('all')) {
                    const allChip = document.createElement('div');
                    allChip.className = 'bucket-chip active';
                    allChip.innerText = 'all';
                    allChip.onclick = () => selectBucket('all');
                    activeContainer.appendChild(allChip);
                }

                // Add active buckets as chips (excluding 'all')
                activeBuckets.filter(b => b !== 'all').forEach(b => {
                    const chip = document.createElement('div');
                    chip.className = 'bucket-chip active';
                    chip.innerText = b;
                    chip.onclick = () => selectBucket(b);
                    activeContainer.appendChild(chip);
                });

                // Update dropdown content with all available buckets
                const dropdownContent = document.getElementById('dropdown-content');
                dropdownContent.innerHTML = '';

                // Add "All" option to dropdown
                const allItem = document.createElement('div');
                allItem.className = `dropdown-item ${activeBuckets.includes('all') ? 'active' : ''}`;
                allItem.innerText = 'all';
                allItem.onclick = () => {
                    selectBucket('all');
                    dropdownContent.classList.remove('show');
                    dropdownVisible = false;
                };
                dropdownContent.appendChild(allItem);

                // Add all other buckets to dropdown
                allKnownBuckets.forEach(b => {
                    if (b !== 'all') {
                        const item = document.createElement('div');
                        item.className = `dropdown-item ${activeBuckets.includes(b) ? 'active' : ''}`;
                        item.innerText = b;
                        item.onclick = () => {
                            selectBucket(b);
                            dropdownContent.classList.remove('show');
                            dropdownVisible = false;
                        };
                        dropdownContent.appendChild(item);
                    }
                });

                // Add "New Bucket" option to dropdown
                const addItem = document.createElement('div');
                addItem.className = 'dropdown-item';
                addItem.innerText = '+ New Bucket';
                addItem.onclick = () => {
                    const name = prompt("New Bucket Name:");
                    if (name) selectBucket(name.toLowerCase().trim());
                    dropdownContent.classList.remove('show');
                    dropdownVisible = false;
                };
                dropdownContent.appendChild(addItem);
            } catch (e) {
                console.error("Failed to load buckets", e);
            }
        }

        function selectBucket(name) {
            if (name === 'all') {
                activeBuckets = ['all'];
            } else {
                // Remove 'all' if it was selected
                activeBuckets = activeBuckets.filter(b => b !== 'all');

                if (activeBuckets.includes(name)) {
                    // Toggle off
                    activeBuckets = activeBuckets.filter(b => b !== name);
                    if (activeBuckets.length === 0) activeBuckets = ['core'];
                } else {
                    // Toggle on
                    activeBuckets.push(name);
                }
            }
            loadBuckets();
        }

        async function search() {
            const query = document.getElementById('query').value;
            const limit = document.getElementById('vol').value;
            const out = document.getElementById('output');
            if (!query) return;
            out.value = "Searching...";
            try {
                const body = { query, max_chars: parseInt(limit) };
                if (!activeBuckets.includes('all')) {
                    body.buckets = activeBuckets;
                }

                const res = await fetch('http://localhost:3000/v1/memory/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                out.value = data.context || "No results.";

                // Send API response to log viewer for debugging
                const logChannel = new BroadcastChannel('sovereign-logs');
                logChannel.postMessage({
                    source: 'Context Console',
                    time: new Date().toISOString(),
                    type: 'info',
                    msg: `Search query: ${query} [Buckets: ${activeBuckets.join(', ')}], Results: ${data.context ? data.context.length : 0} chars`
                });
            } catch (e) {
                out.value = "Error: " + e;

                // Send error to log viewer for debugging
                const logChannel = new BroadcastChannel('sovereign-logs');
                logChannel.postMessage({
                    source: 'Context Console',
                    time: new Date().toISOString(),
                    type: 'error',
                    msg: `Search error: ${e.message}`
                });
            }
        }

        async function research() {
            const query = document.getElementById('query').value;
            const out = document.getElementById('output');
            const max_chars = parseInt(document.getElementById('vol').value);
            if (!query) return;

            // Use at least 100k for research, or the slider value if higher
            const researchChars = Math.max(100000, max_chars);
            out.value = `ðŸ”¬ Performing Deep Research (${Math.floor(researchChars/4).toLocaleString()} tokens)...`;

            try {
                const body = { query, max_chars: researchChars, deep: true };
                if (!activeBuckets.includes('all')) {
                    body.buckets = activeBuckets;
                }

                const res = await fetch('http://localhost:3000/v1/memory/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                out.value = `=== DEEP RESEARCH RESULTS ===\n\n${data.context}` || "No results.";

                const logChannel = new BroadcastChannel('sovereign-logs');
                logChannel.postMessage({
                    source: 'Research Engine',
                    time: new Date().toISOString(),
                    type: 'success',
                    msg: `Deep Research complete for: ${query}`
                });
            } catch (e) {
                out.value = "Research Error: " + e;
            }
        }
        function copy() {
            const el = document.getElementById('output');
            el.select();
            document.execCommand('copy');
        }

        async function downloadBackup() {
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "â³ Exporting...";

            try {
                const res = await fetch('http://localhost:3000/v1/backup');
                if (!res.ok) throw new Error("Backup failed");

                // Convert response to blob and trigger download
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                // The server provides the filename in headers, but we can default
                a.download = `cozo_memory_snapshot_${new Date().toISOString().slice(0,10)}.yaml`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                btn.innerText = "âœ… Exported!";
                setTimeout(() => btn.innerText = originalText, 2000);

            } catch (e) {
                alert("Export Error: " + e.message);
                btn.innerText = "âŒ Failed";
                setTimeout(() => btn.innerText = originalText, 2000);
            }
        }

        async function triggerDream() {
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "ðŸŒ™ Dreaming...";
            const out = document.getElementById('output');
            out.value = "ðŸŒ™ The Dreamer is analyzing and self-organizing your memories...\nThis may take a moment depending on the number of untagged files.";

            try {
                const res = await fetch('http://localhost:3000/v1/dream', { method: 'POST' });
                const data = await res.json();
                
                out.value = `ðŸŒ™ Dream Cycle Complete!\n\nAnalyzed: ${data.analyzed}\nUpdated: ${data.updated}\nTotal Unique Tags: ${data.total_tags}`;
                
                btn.innerText = "âœ… Organized!";
                setTimeout(() => btn.innerText = originalText, 2000);
                
                // Reload buckets to show new ones
                loadBuckets();
            } catch (e) {
                alert("Dream Error: " + e.message);
                btn.innerText = "âŒ Failed";
                setTimeout(() => btn.innerText = originalText, 2000);
            }
        }

        async function ingest() {
            const content = document.getElementById('ingest-text').value;
            const source = document.getElementById('ingest-source').value || 'Manual Ingest';
            if (!content) return alert("Please paste some content first.");

            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "â³ Ingesting...";

            try {
                // For ingestion, we use the first active bucket (excluding 'all')
                const targetBucket = activeBuckets.find(b => b !== 'all') || 'core';

                const res = await fetch('http://localhost:3000/v1/ingest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content, source, type: 'chat', bucket: targetBucket })
                });
                
                if (!res.ok) throw new Error("Ingest failed");
                
                alert(`âœ… Memory ingested successfully into [${targetBucket}]!`);
                document.getElementById('ingest-text').value = "";
                btn.innerText = originalText;
                loadBuckets(); // Refresh bucket list
            } catch (e) {
                alert("Ingest Error: " + e.message);
                btn.innerText = originalText;
            }
        }

        // Initial load
        loadBuckets();

        // Function to update slider from input field
        function updateSliderFromInput() {
            const input = document.getElementById('vol-input');
            const slider = document.getElementById('vol');
            const value = parseInt(input.value);

            // Validate input range
            if (value < 1000) {
                input.value = 1000;
            } else if (value > 4000000) {
                input.value = 4000000;
            } else {
                // Update slider to match input
                slider.value = input.value;

                // Update display values
                document.getElementById('vol-val').innerText = input.value;
                document.getElementById('tok-val').innerText = Math.floor(input.value / 4);
            }
        }

        // Function to set preset values
        function setPreset(value) {
            document.getElementById('vol-input').value = value;
            document.getElementById('vol').value = value;
            document.getElementById('vol-val').innerText = value;
            document.getElementById('tok-val').innerText = Math.floor(value / 4);
        }
    </script>
</body>

</html>