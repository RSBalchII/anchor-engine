<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anchor Engine</title>
    <script crossorigin src="https://unpkg.com/react@18.3.1/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.26.0/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-primary: #000000;
            --bg-secondary: #0a0a0f;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-cyan: #06b6d4;
            --text-primary: #e2e8f0;
            --border-subtle: rgba(148, 163, 184, 0.1);
        }
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            min-height: 100vh;
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 14px rgba(99, 102, 241, 0.4);
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // Simple Router using History API
        const useRouter = () => {
            const [route, setRoute] = useState(window.location.pathname);
            
            useEffect(() => {
                const onPopState = () => setRoute(window.location.pathname);
                window.addEventListener('popstate', onPopState);
                return () => window.removeEventListener('popstate', onPopState);
            }, []);
            
            const navigate = (path) => {
                window.history.pushState({}, '', path);
                setRoute(path);
                lucide.createIcons();
            };
            
            return { route, navigate };
        };

        // API Service
        const api = {
            search: async (params) => {
                const res = await fetch('/v1/memory/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });
                return res.json();
            },
            getBuckets: () => fetch('/v1/buckets').then(r => r.json()),
            getTags: (buckets) => {
                const query = buckets && buckets.length > 0 ? `?buckets=${buckets.join(',')}` : '';
                return fetch(`/v1/tags${query}`).then(r => r.json());
            },
            chat: async (messages, model = 'default') => {
                const res = await fetch('/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages, model })
                });
                return res.json();
            },
            getModels: () => fetch('/v1/models').then(r => r.json()),
            getPaths: () => fetch('/v1/system/paths').then(r => r.json()),
            addPath: (path) => fetch('/v1/system/paths', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path })
            }).then(r => r.json()),
            removePath: (path) => fetch(`/v1/system/paths`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path })
            }).then(r => r.json()),
            // Health and status endpoints
            health: () => fetch('/health').then(r => r.json()),
            getStats: () => fetch('/v1/stats').then(r => r.json()).catch(() => ({ atoms: 0, molecules: 0 }))
        };

        // Loading Screen Component
        const LoadingScreen = ({ onComplete }) => {
            const [status, setStatus] = useState('Initializing...');
            const [stats, setStats] = useState({ atoms: 0, molecules: 0 });
            const [progress, setProgress] = useState(0);

            useEffect(() => {
                let checkCount = 0;
                const maxChecks = 60;
                let prevMolecules = 0;
                let stableCount = 0;

                const checkStatus = async () => {
                    try {
                        const health = await api.health();
                        const currentStats = await api.getStats();
                        
                        setStats(currentStats);
                        
                        const targetMolecules = 280000;
                        const newProgress = Math.min(95, Math.round((currentStats.molecules / targetMolecules) * 100));
                        setProgress(newProgress);

                        if (currentStats.molecules > 0 && currentStats.molecules === prevMolecules) {
                            stableCount++;
                            if (stableCount >= 3 && health.status === 'healthy') {
                                setStatus('✅ Ready!');
                                setTimeout(() => onComplete(), 1000);
                                return;
                            }
                        } else if (currentStats.molecules > prevMolecules) {
                            stableCount = 0;
                            setStatus('Digesting context...');
                        }

                        prevMolecules = currentStats.molecules;
                        checkCount++;

                        if (checkCount >= maxChecks && health.status === 'healthy') {
                            setStatus('✅ Ready!');
                            setTimeout(() => onComplete(), 1000);
                        }
                    } catch (error) {
                        setStatus('Starting up...');
                    }
                };

                checkStatus();
                const interval = setInterval(checkStatus, 2000);
                return () => clearInterval(interval);
            }, [onComplete]);

            return (
                <div className="min-h-screen flex flex-col items-center justify-center relative overflow-hidden" key="loading-screen">
                    <div className="absolute inset-0 bg-gradient-to-br from-purple-900/10 via-black to-black"></div>
                    <div className="relative z-10 text-center px-4">
                        <div className="mb-8">
                            <div className="relative inline-block">
                                <div className="w-20 h-20 border-4 border-cyan-500/30 border-t-cyan-500 rounded-full animate-spin"></div>
                            </div>
                        </div>

                        <h1 className="text-4xl font-bold mb-2 bg-gradient-to-r from-cyan-400 to-purple-500 bg-clip-text text-transparent">
                            Anchor Engine
                        </h1>
                        <p className="text-gray-400 mb-8">Sovereign Context Protocol</p>

                        <div className="glass-panel p-6 mb-6 max-w-md mx-auto">
                            <div className="flex items-center justify-center gap-3 mb-4">
                                <div className="flex space-x-1">
                                    <div className="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style={{animationDelay: '0ms'}}></div>
                                    <div className="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style={{animationDelay: '150ms'}}></div>
                                    <div className="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style={{animationDelay: '300ms'}}></div>
                                </div>
                            </div>
                            <p className="text-lg text-gray-300 mb-2">{status}</p>
                            {stats.molecules > 0 && (
                                <p className="text-sm text-gray-500">
                                    {stats.molecules.toLocaleString()} molecules • {stats.atoms.toLocaleString()} atoms
                                </p>
                            )}
                            
                            <div className="mt-4 h-1 bg-gray-800 rounded-full overflow-hidden">
                                <div 
                                    className="h-full bg-gradient-to-r from-cyan-500 to-purple-500 transition-all duration-500"
                                    style={{width: `${progress}%`}}
                                ></div>
                            </div>
                        </div>

                        <p className="text-sm text-gray-600">
                            Preparing your context for optimal retrieval...
                        </p>
                    </div>
                </div>
            );
        };

        // Landing Page Component
        const LandingPage = ({ navigate }) => (
            <div className="min-h-screen flex flex-col items-center justify-center relative overflow-hidden">
                <div className="absolute inset-0 bg-gradient-to-br from-purple-900/10 via-black to-black"></div>
                <div className="relative z-10 text-center px-4 fade-in">
                    <div className="mb-12">
                        <div className="flex items-center justify-center gap-3 mb-4">
                            <i data-lucide="anchor" className="text-cyan-400" width="48" height="48"></i>
                        </div>
                        <h1 className="text-5xl font-bold mb-3 bg-gradient-to-r from-cyan-400 to-purple-500 bg-clip-text text-transparent">
                            Anchor Engine
                        </h1>
                        <p className="text-gray-400 text-lg">Sovereign Context Protocol</p>
                        <div className="flex items-center justify-center gap-2 mt-3 text-sm text-gray-500">
                            <span className="w-2 h-2 rounded-full bg-green-500" style={{animation: 'pulse 2s infinite'}}></span>
                            <span>System Online</span>
                        </div>
                    </div>
                    <div className="flex flex-col gap-4 mb-12">
                        <button onClick={() => navigate('/chat')} className="btn-primary text-lg px-8 py-4 flex items-center gap-3 mx-auto">
                            <i data-lucide="message-square" width="24"></i>
                            <span>Coda Chat</span>
                        </button>
                        <button onClick={() => navigate('/search')} className="btn-primary text-lg px-8 py-4 flex items-center gap-3 mx-auto">
                            <i data-lucide="search" width="24"></i>
                            <span>Memory Search</span>
                        </button>
                        <button onClick={() => navigate('/paths')} className="btn-primary text-lg px-8 py-4 flex items-center gap-3 mx-auto">
                            <i data-lucide="git-branch" width="24"></i>
                            <span>Knowledge Paths</span>
                        </button>
                    </div>
                    <div className="text-gray-600 text-sm">
                        <p>Local-First AI Memory & Context Engine</p>
                        <p className="mt-1">v4.0.0 • Production Ready</p>
                    </div>
                </div>
            </div>
        );

        // Chat Component
        const ChatPage = ({ navigate }) => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [models, setModels] = useState([]);
            const [selectedModel, setSelectedModel] = useState('');

            useEffect(() => {
                api.getModels().then(setModels).catch(() => setModels([]));
                lucide.createIcons();
            }, []);

            const handleSend = async () => {
                if (!input.trim() || loading) return;
                const userMsg = { role: 'user', content: input };
                setMessages(prev => [...prev, userMsg]);
                setInput('');
                setLoading(true);

                try {
                    const data = await api.chat([...messages, userMsg], selectedModel || 'default');
                    const assistantMsg = { role: 'assistant', content: data.choices?.[0]?.message?.content || 'No response' };
                    setMessages(prev => [...prev, assistantMsg]);
                } catch (error) {
                    setMessages(prev => [...prev, { role: 'system', content: `Error: ${error.message}` }]);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="h-screen flex flex-col">
                    <div className="p-4 border-b border-white/10 flex justify-between items-center bg-black/20">
                        <div className="flex items-center gap-3">
                            <button onClick={() => navigate('/')} className="btn-secondary text-sm px-3 py-1.5">
                                ← Back
                            </button>
                            <h1 className="text-xl font-bold text-purple-400">Coda Chat</h1>
                        </div>
                        <select 
                            value={selectedModel} 
                            onChange={(e) => setSelectedModel(e.target.value)}
                            className="bg-black/40 border border-gray-700 rounded px-3 py-1.5 text-sm"
                        >
                            <option value="">Select Model...</option>
                            {models.map(m => <option key={m.id} value={m.id}>{m.id}</option>)}
                        </select>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {messages.length === 0 ? (
                            <div className="text-center text-gray-500 mt-20">
                                <i data-lucide="message-square" className="mx-auto mb-4 opacity-20" width="48"></i>
                                <p>Start a conversation...</p>
                            </div>
                        ) : (
                            messages.map((msg, i) => (
                                <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[80%] rounded-lg p-3 ${
                                        msg.role === 'user' ? 'bg-purple-600/20 border border-purple-500/30' :
                                        msg.role === 'system' ? 'bg-red-900/20 border border-red-500/30 text-red-200' :
                                        'bg-black/30 border border-gray-700/50'
                                    }`}>
                                        {msg.content}
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                    <div className="p-4 border-t border-white/10 flex gap-2">
                        <textarea
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), handleSend())}
                            placeholder="Type a message..."
                            className="flex-1 bg-black/40 border border-gray-700 rounded-lg p-3 resize-none h-[60px] focus:border-purple-500 outline-none"
                        ></textarea>
                        <button onClick={handleSend} disabled={loading} className="btn-primary h-[60px] px-6">
                            {loading ? '...' : 'Send'}
                        </button>
                    </div>
                </div>
            );
        };

        // Search Component
        const SearchPage = ({ navigate }) => {
            const [query, setQuery] = useState('');
            const [results, setResults] = useState([]);
            const [loading, setLoading] = useState(false);
            const [buckets, setBuckets] = useState([]);
            const [selectedBuckets, setSelectedBuckets] = useState([]);
            const [tokenBudget, setTokenBudget] = useState(4096);
            const [showBucketSelector, setShowBucketSelector] = useState(false);
            const [showTokenSlider, setShowTokenSlider] = useState(false);

            useEffect(() => {
                api.getBuckets().then(setBuckets).catch(() => setBuckets([]));
                lucide.createIcons();
            }, []);

            useEffect(() => {
                // Initialize icons when results change
                if (results.length > 0 || loading) {
                    setTimeout(() => lucide.createIcons(), 100);
                }
            }, [results, loading]);

            const handleSearch = async () => {
                if (!query.trim()) return;
                setLoading(true);
                setResults([]);
                try {
                    const data = await api.search({
                        query,
                        max_chars: tokenBudget * 4,
                        token_budget: tokenBudget,
                        provenance: 'all',
                        buckets: selectedBuckets.length > 0 ? selectedBuckets : undefined
                    });
                    setResults(data.results || []);
                } catch (error) {
                    console.error('Search error:', error);
                    setResults([{ id: 'error', content: `Search failed: ${error.message}`, source: 'System', score: 0 }]);
                } finally {
                    setLoading(false);
                }
            };

            const toggleBucket = (bucket) => {
                setSelectedBuckets(prev => {
                    if (prev.includes(bucket)) {
                        const updated = prev.filter(b => b !== bucket);
                        return updated;
                    } else {
                        return [...prev, bucket];
                    }
                });
            };

            const clearBucketSelection = () => {
                setSelectedBuckets([]);
            };

            const formatTokenCount = (num) => {
                if (num >= 1000000) return `${(num / 1000000).toFixed(1)}M`;
                if (num >= 1000) return `${(num / 1000).toFixed(0)}K`;
                return num.toString();
            };

            const formatSource = (source) => {
                if (!source) return 'Unknown';
                const parts = source.split(/[\\/]/);
                return parts.slice(-2).join('/');
            };

            return (
                <div className="h-screen flex flex-col">
                    <div className="p-4 border-b border-white/10 flex justify-between items-center bg-black/20">
                        <div className="flex items-center gap-3">
                            <button onClick={() => navigate('/')} className="btn-secondary text-sm px-3 py-1.5">
                                ← Back
                            </button>
                            <h1 className="text-xl font-bold text-cyan-400">Memory Search</h1>
                        </div>
                    </div>
                    <div className="p-4 border-b border-white/10 space-y-4">
                        <div className="flex gap-2">
                            <form onSubmit={(e) => { e.preventDefault(); handleSearch(); }} className="flex-1 flex gap-2">
                                <input
                                    type="text"
                                    value={query}
                                    onChange={(e) => setQuery(e.target.value)}
                                    onKeyDown={(e) => {
                                        if (e.key === 'Enter') {
                                            e.preventDefault();
                                            handleSearch();
                                        }
                                    }}
                                    placeholder="Search your memory..."
                                    className="flex-1 bg-black/40 border border-gray-700 rounded-lg p-3 focus:border-cyan-500 outline-none"
                                />
                                <button type="submit" disabled={loading} className="btn-primary px-6 min-w-[100px]">
                                    {loading ? (
                                        <span className="flex items-center justify-center gap-2">
                                            <span className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
                                            Searching
                                        </span>
                                    ) : 'Search'}
                                </button>
                            </form>
                        </div>
                        
                        {/* Controls Row */}
                        <div className="flex gap-2">
                            <button
                                onClick={() => setShowTokenSlider(!showTokenSlider)}
                                className={`flex-1 text-sm px-4 py-2 rounded-lg border transition-all flex items-center justify-center gap-2 ${
                                    showTokenSlider 
                                        ? 'bg-cyan-600/30 border-cyan-500 text-cyan-400' 
                                        : 'bg-black/40 border-gray-700 text-gray-400 hover:border-gray-500'
                                }`}
                            >
                                <i data-lucide="coins" width="16"></i>
                                <span>Token Budget: {formatTokenCount(tokenBudget)}</span>
                            </button>
                            <button
                                onClick={() => setShowBucketSelector(!showBucketSelector)}
                                className={`flex-1 text-sm px-4 py-2 rounded-lg border transition-all flex items-center justify-center gap-2 ${
                                    showBucketSelector 
                                        ? 'bg-cyan-600/30 border-cyan-500 text-cyan-400' 
                                        : 'bg-black/40 border-gray-700 text-gray-400 hover:border-gray-500'
                                }`}
                            >
                                <i data-lucide="folder" width="16"></i>
                                <span>Buckets {selectedBuckets.length > 0 ? `(${selectedBuckets.length})` : ''}</span>
                            </button>
                        </div>

                        {/* Token Budget Drawer */}
                        {showTokenSlider && (
                            <div className="glass-panel p-4 fade-in">
                                <div className="flex items-center justify-between mb-3">
                                    <div className="flex items-center gap-2 text-sm text-gray-300">
                                        <i data-lucide="coins" width="16"></i>
                                        <span>Context Token Limit</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <input
                                            type="number"
                                            value={tokenBudget}
                                            onChange={(e) => setTokenBudget(Math.max(256, Math.min(1000000, parseInt(e.target.value) || 256)))}
                                            className="w-28 bg-black/40 border border-gray-700 rounded px-2 py-1 text-sm text-right focus:border-cyan-500 outline-none"
                                            min="256"
                                            max="1000000"
                                            step="256"
                                        />
                                        <span className="text-xs text-gray-500">tokens</span>
                                    </div>
                                </div>
                                <input
                                    type="range"
                                    min="256"
                                    max="1000000"
                                    step="256"
                                    value={tokenBudget}
                                    onChange={(e) => setTokenBudget(parseInt(e.target.value))}
                                    className="w-full h-2 bg-gray-800 rounded-lg appearance-none cursor-pointer accent-cyan-500"
                                />
                                <div className="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>256</span>
                                    <span className="text-cyan-400 font-semibold">{formatTokenCount(tokenBudget)}</span>
                                    <span>1M</span>
                                </div>
                                <p className="text-xs text-gray-500 mt-2">
                                    Higher token limits return more context per result. Each result includes surrounding atoms from the same document.
                                </p>
                            </div>
                        )}

                        {/* Bucket Selector Drawer */}
                        {showBucketSelector && (
                            <div className="glass-panel p-4 fade-in">
                                <div className="flex items-center justify-between mb-3">
                                    <div className="flex items-center gap-2 text-sm text-gray-300">
                                        <i data-lucide="folder" width="16"></i>
                                        <span>Search Buckets</span>
                                        {selectedBuckets.length > 0 && (
                                            <span className="text-xs text-cyan-400">({selectedBuckets.length} selected)</span>
                                        )}
                                    </div>
                                    {selectedBuckets.length > 0 && (
                                        <button
                                            onClick={clearBucketSelection}
                                            className="text-xs px-3 py-1 bg-cyan-600/30 border border-cyan-500 rounded text-cyan-400 hover:bg-cyan-600/50 transition-colors"
                                        >
                                            Clear Selection
                                        </button>
                                    )}
                                </div>
                                
                                <div className="flex gap-2 flex-wrap">
                                    {buckets.length === 0 ? (
                                        <p className="text-sm text-gray-500">No buckets available</p>
                                    ) : (
                                        buckets.map(bucket => (
                                            <button
                                                key={bucket}
                                                onClick={() => toggleBucket(bucket)}
                                                className={`text-xs px-3 py-1.5 rounded border transition-all ${
                                                    selectedBuckets.includes(bucket)
                                                        ? 'bg-cyan-600/30 border-cyan-500 text-cyan-400 shadow-[0_0_10px_rgba(6,182,212,0.3)]'
                                                        : 'bg-black/40 border-gray-700 text-gray-400 hover:border-gray-500'
                                                }`}
                                            >
                                                {bucket}
                                            </button>
                                        ))
                                    )}
                                </div>
                                
                                {selectedBuckets.length > 0 && (
                                    <div className="mt-3 pt-3 border-t border-gray-800">
                                        <p className="text-xs text-gray-500">
                                            Searching in: <span className="text-cyan-400">{selectedBuckets.join(', ')}</span>
                                        </p>
                                        <p className="text-xs text-gray-600 mt-1">
                                            Untoggle all to search all buckets
                                        </p>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                    <div className="flex-1 overflow-y-auto p-4">
                        {loading ? (
                            <div className="text-center text-gray-500 mt-20">
                                <div className="w-12 h-12 border-4 border-cyan-500/30 border-t-cyan-500 rounded-full animate-spin mx-auto mb-4"></div>
                                <p>Searching your memory...</p>
                                <p className="text-xs text-gray-600 mt-2">This may take a moment for large contexts</p>
                            </div>
                        ) : results.length === 0 ? (
                            <div className="text-center text-gray-500 mt-20">
                                <i data-lucide="search" className="mx-auto mb-4 opacity-20" width="48"></i>
                                <p>Enter a query to search your memory</p>
                                <p className="text-xs text-gray-600 mt-2">Results will show context-aware atoms with surrounding content</p>
                            </div>
                        ) : (
                            <div className="grid gap-4 pb-4">
                                <div className="flex justify-between items-center text-sm text-gray-500">
                                    <span>Found {results.length} result{results.length !== 1 ? 's' : ''}</span>
                                    <span className="text-xs">Results include surrounding atoms from each document</span>
                                </div>
                                {results.map((result, i) => (
                                    <div key={result.id || i} className="glass-panel p-5 hover:border-cyan-500/50 transition-colors">
                                        <div className="flex justify-between items-start mb-3">
                                            <div className="flex items-center gap-2">
                                                <span className="text-xs text-cyan-400 font-mono">{formatSource(result.source)}</span>
                                                {result.buckets && result.buckets.length > 0 && (
                                                    <div className="flex gap-1">
                                                        {result.buckets.slice(0, 3).map((bucket, j) => (
                                                            <span key={j} className="text-xs px-2 py-0.5 bg-gray-800 rounded text-gray-400">
                                                                {bucket}
                                                            </span>
                                                        ))}
                                                        {result.buckets.length > 3 && (
                                                            <span className="text-xs px-2 py-0.5 bg-gray-800 rounded text-gray-400">
                                                                +{result.buckets.length - 3}
                                                            </span>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex items-center gap-3 text-xs">
                                                <span className="text-gray-500">Score: <span className="text-cyan-400 font-semibold">{result.score?.toFixed(3)}</span></span>
                                                {result.provenance && (
                                                    <span className={`px-2 py-0.5 rounded ${
                                                        result.provenance === 'sovereign' ? 'bg-green-600/30 text-green-400' :
                                                        result.provenance === 'external' ? 'bg-blue-600/30 text-blue-400' :
                                                        'bg-gray-600/30 text-gray-400'
                                                    }`}>
                                                        {result.provenance}
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                        <div className="prose prose-invert prose-sm max-w-none">
                                            <p className="text-sm text-gray-300 whitespace-pre-wrap leading-relaxed">{result.content}</p>
                                        </div>
                                        {result.metadata && (
                                            <div className="mt-3 pt-3 border-t border-gray-800 flex gap-4 text-xs text-gray-500">
                                                {result.metadata.tokens && (
                                                    <span>~{formatTokenCount(result.metadata.tokens)} tokens</span>
                                                )}
                                                {result.metadata.atoms && (
                                                    <span>{result.metadata.atoms} atom{result.metadata.atoms !== 1 ? 's' : ''}</span>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Paths Component
        const PathsPage = ({ navigate }) => {
            const [paths, setPaths] = useState([]);
            const [newPath, setNewPath] = useState('');
            const [loading, setLoading] = useState(false);

            const loadPaths = useCallback(async () => {
                try {
                    const data = await api.getPaths();
                    setPaths(data.paths || []);
                } catch (error) {
                    console.error('Failed to load paths:', error);
                }
            }, []);

            useEffect(() => {
                loadPaths();
                lucide.createIcons();
            }, [loadPaths]);

            const handleAddPath = async () => {
                if (!newPath.trim()) return;
                setLoading(true);
                try {
                    await api.addPath(newPath);
                    setNewPath('');
                    loadPaths();
                } catch (error) {
                    alert('Failed to add path: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleRemovePath = async (pathToRemove) => {
                if (!confirm(`Remove this path?\n\n${pathToRemove}`)) return;
                setLoading(true);
                try {
                    await api.removePath(pathToRemove);
                    loadPaths();
                } catch (error) {
                    alert('Failed to remove path: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="h-screen flex flex-col">
                    <div className="p-4 border-b border-white/10 flex justify-between items-center bg-black/20">
                        <div className="flex items-center gap-3">
                            <button onClick={() => navigate('/')} className="btn-secondary text-sm px-3 py-1.5">
                                ← Back
                            </button>
                            <h1 className="text-xl font-bold text-green-400">Knowledge Paths</h1>
                        </div>
                    </div>
                    <div className="p-4 border-b border-white/10">
                        <div className="flex gap-2">
                            <input
                                type="text"
                                value={newPath}
                                onChange={(e) => setNewPath(e.target.value)}
                                onKeyDown={(e) => e.key === 'Enter' && handleAddPath()}
                                placeholder="Path to watch (e.g., C:\\Users\\Docs)"
                                className="flex-1 bg-black/40 border border-gray-700 rounded-lg p-3 focus:border-green-500 outline-none"
                            />
                            <button onClick={handleAddPath} disabled={loading} className="btn-primary px-6">
                                {loading ? 'Adding...' : 'Add Path'}
                            </button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4">
                        {paths.length === 0 ? (
                            <div className="text-center text-gray-500 mt-20">
                                <i data-lucide="folder-open" className="mx-auto mb-4 opacity-20" width="48"></i>
                                <p>No paths configured. Add a path to start watching for files.</p>
                            </div>
                        ) : (
                            <div className="space-y-2">
                                {paths.map((path, i) => (
                                    <div key={i} className="glass-panel p-4 flex justify-between items-center">
                                        <span className="text-sm">{path}</span>
                                        <button 
                                            onClick={() => handleRemovePath(path)}
                                            className="text-red-400 hover:text-red-300 p-2"
                                        >
                                            <i data-lucide="trash-2" width="18"></i>
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const { route, navigate } = useRouter();
            const [isLoading, setIsLoading] = useState(true);
            const [hasLoadedOnce, setHasLoadedOnce] = useState(false);

            useEffect(() => {
                // Only initialize icons when not loading
                if (!isLoading) {
                    setTimeout(() => lucide.createIcons(), 100);
                }
            }, [route, isLoading]);

            useEffect(() => {
                const checkReady = async () => {
                    try {
                        const health = await api.health();
                        if (health.status === 'healthy' && !hasLoadedOnce) {
                            setHasLoadedOnce(true);
                            setIsLoading(false);
                        }
                    } catch (error) {
                        console.log('Waiting for system...');
                    }
                };
                
                if (isLoading) {
                    checkReady();
                    const interval = setInterval(checkReady, 1000);
                    return () => clearInterval(interval);
                }
            }, [isLoading, hasLoadedOnce]);

            if (isLoading) {
                return <LoadingScreen key="loading" onComplete={() => { setHasLoadedOnce(true); setIsLoading(false); }} />;
            }

            if (route === '/' || route === '') return <LandingPage key="landing" navigate={navigate} />;
            if (route === '/chat') return <ChatPage key="chat" navigate={navigate} />;
            if (route === '/search') return <SearchPage key="search" navigate={navigate} />;
            if (route === '/paths') return <PathsPage key="paths" navigate={navigate} />;
            
            return (
                <div className="min-h-screen flex items-center justify-center" key="notfound">
                    <div className="text-center">
                        <h1 className="text-4xl font-bold mb-4">404</h1>
                        <p className="text-gray-400 mb-4">Page not found</p>
                        <button onClick={() => navigate('/')} className="btn-primary">
                            Go Home
                        </button>
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App key="app" />);
    </script>
</body>
</html>
